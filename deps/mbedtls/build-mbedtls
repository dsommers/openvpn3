#!/bin/bash

set -e
if [ -z "$O3" ]; then
    echo O3 var must point to ovpn3 tree
    exit 1
fi
if [ -z "$TARGET" ]; then
    echo TARGET var must be defined
    exit 1
fi

# source vars
. $O3/core/vars/vars-${TARGET}
. $O3/core/deps/lib-versions

# extract the mbedTLS source
PD=$O3/core/deps/mbedtls
DIST=mbedtls-$PLATFORM

rm -rf $DIST
mkdir $DIST

if [ "$NO_WIPE" = "1" ]; then
    echo RETAIN existing source
    cd $MBEDTLS_VERSION
else
    echo WIPE and reunzip source
    rm -rf $MBEDTLS_VERSION
    [ -z "$DL" ] && DL=~/Downloads
    tar xfz $DL/$MBEDTLS_VERSION-apache.tgz
    cd $MBEDTLS_VERSION

    # enable MD4 (needed for NTLM auth)
    perl -pi -e 's/^\/\/// if /#define MBEDTLS_MD4_C/' include/mbedtls/config.h
fi

# build it
pwd
cd ../$DIST
cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_PROGRAMS=Off -DENABLE_TESTING=Off ../$MBEDTLS_VERSION
if [ "$VERBOSE" = "1" ]; then
    make VERBOSE=1
else
    make
fi

# test it
if [ "$ENABLE_TESTING" = "1" ]; then
    make test
fi

# copy headers
cp -a ../$MBEDTLS_VERSION/include/mbedtls include/
exit 0
